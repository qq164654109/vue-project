!function(e,O,o){"use strict";var f="ht",Z=e[f],B=Z.Default,k=B.def,j=B.getInternal();Z.HistoryManager=function(q){this._histories=[],this.setDataModel(q)},k(Z.HistoryManager,O,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var X=this;X._betweenTransaction++,1===X._betweenTransaction&&(X._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var Y=this,O=Y._histories;Y._betweenTransaction>0&&Y._betweenTransaction--,0===Y._betweenTransaction&&(Y._transactionHistories&&Y._transactionHistories.length&&(O=O.slice(0,Y._historyIndex+1),O.push(Y._transactionHistories),O.length>Y._maxHistoryCount&&(O=O.slice(O.length-Y._maxHistoryCount)),Y.setHistories(O),Y.setHistoryIndex(O.length-1,!0)),delete Y._transactionHistories)}},setDataModel:function(q){var N=this,M=N._dataModel;M!==q&&(M&&(delete M._historyManager,M.ump(N.handleDataModelPropertyChange,N),M.umm(N.$5p,N),M.umd(N.$6p,N),M.removeHierarchyChangeListener(N.handleHierarchyChange,N),M.removeIndexChangeListener(N.handleIndexChange,N)),N._dataModel=q,q&&(q._historyManager=N,q.mp(N.handleDataModelPropertyChange,N),q.mm(N.$5p,N),q.md(N.$6p,N),q.addHierarchyChangeListener(N.handleHierarchyChange,N),q.addIndexChangeListener(N.handleIndexChange,N)),N.fp("dataModel",M,q),N.clear())},setHistoryIndex:function(K,b){var I=this,G=I._historyIndex,_=I._histories.length;if(-1>K?K=-1:K>=_&&(K=_-1),G!==K){if(!b){var N=K-G;N>0?I.$2p(N):0>N&&I.$1p(-N)}I._historyIndex=K,I.fp("historyIndex",G,K),I.dataModel&&I.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(r){var K=this,f=K._histories,G=K._maxHistoryCount;(!r||0>=r)&&(r=10),G!==r&&(K._maxHistoryCount=r,K.fp("maxHistoryCount",G,r),f.length>r&&K.clear())},cloneValue:function(l){return Z.Default.clone(l)},isPropertyUndoable:function(U){return U&&!this.ignoredPropertyMap[U]},isDataModelPropertyUndoable:function(J){return J&&!this.ignoreDataModelPropertyMap[J]},$5p:function(H){this.handleChange(H,H.kind)},$6p:function(j){this.handleChange(j,"property")},handleHierarchyChange:function(X){this.handleChange(X,"hierarchy")},handleIndexChange:function(n){this.handleChange(n,"index")},handleDataModelPropertyChange:function(g){this.handleChange(g,"dataModelProperty")},toChildrenInfo:function(A){var u={};return u.data=A,u.children=[],A.eachChild(function(c){u.children.push(this.toChildrenInfo(c))},this),u},restoreChildren:function(R){var K=R.data;R.children.forEach(function(H){var w=H.data;w.getParent()!==K&&K.addChild(w),this._dataModel.contains(w)||this._dataModel.add(w),this.restoreChildren(H)},this)},handleChange:function(l,K){var f=this;if(!(f._disabled||f._isUndoRedoing||B.loadingRefGraph)){var H,M=(f._histories,l.data),_=l.property;if(!M||!(M._refGraph||M instanceof Z.RefGraph)){if("property"===K)f.isPropertyUndoable(_,M)&&(H={kind:K,data:M,property:_,oldValue:f.cloneValue(l.oldValue,M,_),newValue:f.cloneValue(l.newValue,M,_),event:l});else if("hierarchy"===K||"index"===K)H={kind:K,data:M,oldIndex:l.oldIndex,newIndex:l.newIndex,event:l};else if("clear"===K)H={kind:K,json:l.json,event:l};else if("add"===K){if(H={kind:K,data:M,event:l,childrenInfo:this.toChildrenInfo(M),parent:M.getParent()},H.parent){var F=f._dataModel.getSiblings(M);H.siblingsIndex=F.indexOf(M)}M instanceof Z.Node&&(H.host=M.getHost(),H.attaches=M.getAttaches()?M.getAttaches().toArray():o),M instanceof Z.Edge&&(H.source=M.getSource(),H.target=M.getTarget())}else"remove"===K?H={kind:K,data:M,event:l}:"dataModelProperty"===K&&f.isDataModelPropertyUndoable(_,M)&&(H={kind:K,property:_,oldValue:f.cloneValue(l.oldValue,M,_),newValue:f.cloneValue(l.newValue,M,_),event:l});f.addHistory(H)}}},addHistory:function(x){var Z=this;if(x)if(Z._betweenTransaction){var n=!1;if("property"===x.kind||"dataModelProperty"===x.kind)for(var e=Z._transactionHistories.length-1;e>=0;e--){var h=Z._transactionHistories[e];if(x.kind===h.kind&&x.property===h.property&&x.data===h.data){x.oldValue=h.oldValue,Z._transactionHistories[e]=x,n=!0;break}}n||Z._transactionHistories.push(x)}else{var c=Z._histories;c=c.slice(0,Z._historyIndex+1),c.push([x]),c.length>Z._maxHistoryCount&&(c=c.slice(c.length-Z._maxHistoryCount)),Z.setHistories(c),Z.setHistoryIndex(c.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(n){(!n||0>=n)&&(n=1),this.setHistoryIndex(this._historyIndex-n)},$1p:function(C){if(this.canUndo()){var _,b=this,o=b._dataModel,I=b._histories,Y=b._historyIndex,z=0;for(b._isUndoRedoing=!0,B.setIsolating(!0);C>0;){if(Y>=0&&Y<I.length){z++,_=I[Y],Y--;for(var c=_.length-1;c>=0;c--){var Q=_[c],M=Q.kind,V=Q.data,q=Q.property,p=Q.event,l=this.cloneValue(Q.oldValue,V,q);if(Q.undo)Q.undo();else if("add"===M)o.remove(V,{keepChildren:!0});else if("remove"===M)o.contains(V)||o.add(V,p.rootsIndex,p.datasIndex);else if("clear"===M)o.deserialize(B.clone(Q.json));else if("property"===M)if("parent"===q)l?l.addChild(V,p.oldIndex):(V.setParent(l),p.oldIndex>=0&&o.moveTo(V,p.oldIndex));else{var X=null;0===q.indexOf("a:")?(X="attr",q=q.replace("a:","")):0===q.indexOf("s:")?(X="style",q=q.replace("s:","")):0===q.indexOf("f:")&&(X="field",q=q.replace("f:","")),j.setPropertyValue(V,X,q,l)}else if("dataModelProperty"===M){var X=null;0===q.indexOf("a:")?(X="attr",q=q.replace("a:","")):0===q.indexOf("s:")?(X="style",q=q.replace("s:","")):0===q.indexOf("f:")&&(X="field",q=q.replace("f:","")),j.setPropertyValue(o,X,q,l)}else"hierarchy"===M?o.moveTo(V,Q.oldIndex):"index"===M&&o.moveToIndex(V,Q.oldIndex)}}C--}B.setIsolating(!1),delete b._isUndoRedoing,b.afterUndo(z)}},afterUndo:function(){},redo:function(A){(!A||0>=A)&&(A=1),this.setHistoryIndex(this._historyIndex+A)},$2p:function(o){if(this.canRedo()){var y,J=this,z=J._dataModel,u=J._histories,O=J._historyIndex,e=0;for(J._isUndoRedoing=!0,B.setIsolating(!0);o>0;){if(O>=-1&&O<u.length-1){e++,O++,y=u[O];for(var g=0;g<y.length;g++){var q=y[g],l=q.kind,n=q.data,G=q.property,s=q.event,i=this.cloneValue(q.newValue,n,G);if(q.redo)q.redo();else if("add"===l)q.parent&&!n.getParent()&&q.parent.addChild(n,q.siblingsIndex),z.contains(n)||z.add(n,s.rootsIndex,s.datasIndex),this.restoreChildren(q.childrenInfo),n instanceof Z.Node&&(n.setHost(q.host),q.attaches&&q.attaches.forEach(function(U){U.setHost(n)})),n instanceof Z.Edge&&(n.setSource(q.source),n.setTarget(q.target));else if("remove"===l)z.remove(n);else if("clear"===l)z.clear();else if("property"===l)if("parent"===G)i?i.addChild(n,s.newIndex):(n.setParent(i),s.newIndex>=0&&z.moveTo(n,s.newIndex));else{var x=null;0===G.indexOf("a:")?(x="attr",G=G.replace("a:","")):0===G.indexOf("s:")?(x="style",G=G.replace("s:","")):0===G.indexOf("f:")&&(x="field",G=G.replace("f:","")),j.setPropertyValue(n,x,G,i)}else if("dataModelProperty"===l){var x=null;0===G.indexOf("a:")?(x="attr",G=G.replace("a:","")):0===G.indexOf("s:")?(x="style",G=G.replace("s:","")):0===G.indexOf("f:")&&(x="field",G=G.replace("f:","")),j.setPropertyValue(z,x,G,i)}else"hierarchy"===l?z.moveTo(n,q.newIndex):"index"===l&&z.moveToIndex(n,q.newIndex)}}o--}B.setIsolating(!1),delete J._isUndoRedoing,this.afterRedo(e)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);